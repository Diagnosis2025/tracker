<!doctype html>
<html lang="es">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Diagnosis Track â€” Web</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="./styles.css" />
  <style>
    /* Estilos para el menÃº desplegable */
    .dropdown {
      position: relative;
      display: inline-block;
    }

    .dropdown-content {
      position: absolute;
      background-color: #f9f9f9;
      min-width: 200px;
      box-shadow: 0px 8px 16px 0px rgba(0, 0, 0, 0.2);
      z-index: 1000;
      border-radius: 4px;
      overflow: hidden;
      top: 100%;
      left: 0;
    }

    .dropdown-content a {
      color: black;
      padding: 12px 16px;
      text-decoration: none;
      display: block;
      cursor: pointer;
      border-bottom: 1px solid #eee;
    }

    .dropdown-content a:last-child {
      border-bottom: none;
    }

    .dropdown-content a:hover {
      background-color: #f1f1f1;
    }

    /* Estilos modernos para el login */
    .auth-container {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
      background-image: url('./assets/images/ciudad_inteligente.png');
      background-size: cover;
      background-position: center;
      position: relative;
    }

    .auth-container::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      z-index: 1;
    }

    .auth-card {
      background: white;
      border-radius: 16px;
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
      padding: 2.5rem;
      width: 100%;
      max-width: 420px;
      transition: transform 0.3s ease;
      position: relative;
      z-index: 2;
    }

    .auth-card:hover {
      transform: translateY(-5px);
    }

    .auth-card h1 {
      text-align: center;
      margin-bottom: 1.5rem;
      color: #2d3748;
      font-weight: 700;
      font-size: 1.8rem;
    }

    .auth-input {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e2e8f0;
      border-radius: 10px;
      font-size: 16px;
      transition: all 0.3s ease;
      margin-bottom: 1rem;
    }

    .auth-input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .auth-btn {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .auth-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
    }

    .auth-btn:active {
      transform: translateY(0);
    }

    .hidden {
      display: none !important;
    }

    /* Estilo para el Ã­cono en la App Bar */
    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .brand-icon {
      width: 28px;
      height: 28px;
    }

    /* ===== NUEVOS ESTILOS PARA EL FOOTER ===== */
    .login-footer {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      text-align: center;
      padding: 10px;
      font-size: 14px;
      z-index: 3;
      /* Por encima del overlay pero debajo del formulario */
    }

    .login-footer a {
      color: #fff;
      text-decoration: none;
    }

    .login-footer a:hover {
      text-decoration: underline;
    }

    .login-footer.hidden {
      display: none;
    }
  </style>
</head>

<body>
  <header class="topbar hidden">
  <div class="brand">
    <img src="./assets/images/ic_launcher.png" alt="Icono" class="brand-icon" />
    <span>Diagnosis Track</span>
  </div>
  <div class="toolbar">
    <!-- BotÃ³n de menÃº hamburguesa -->
    <div class="dropdown">
      <button id="btnMenu" class="btn btn-icon-text" aria-expanded="false">
        <span class="icon">â˜°</span>
        <span class="text">MenÃº</span>
      </button>
      <div id="menuContent" class="dropdown-content hidden">
        <a href="#" id="menuLoadCSV" class="menu-item">
          <span class="menu-icon">ğŸ“</span>
          <span>Cargar rutas</span>
        </a>
        <a href="#" id="menuEdit" class="menu-item hidden">
          <span class="menu-icon">âœï¸</span>
          <span>Editar atributos</span>
        </a>
        <a href="#" id="menuBases" class="menu-item hidden">
        <span class="menu-icon">ğŸ¢</span>
        <span>Agregar base</span>
       </a>
        <a href="#" id="menuReports" class="menu-item">
          <span class="menu-icon">ğŸ“Š</span>
          <span>Informe de KM</span>
        </a>
        <a href="#" id="menuExit" class="menu-item">
          <span class="menu-icon">ğŸšª</span>
          <span>Salir</span>
        </a>
      </div>
    </div>

    <button id="btnRefresh" class="btn btn-icon-text">
      <span class="icon">ğŸ”„</span>
      <span class="text">Actualizar</span>
    </button>
    
    <button id="btnSearch" class="btn btn-icon-text">
      <span class="icon">ğŸ”</span>
      <span class="text">Buscar</span>
    </button>
    
    <button id="btnFleet" class="btn btn-icon-text">
      <span class="icon">ğŸš—</span>
      <span class="text">Mi flota</span>
    </button>
    
    <button id="btnLocate" class="btn btn-icon-text">
      <span class="icon">ğŸ“</span>
      <span class="text">Mi ubicaciÃ³n</span>
    </button>
    
    <span class="units">
      <span class="icon">ğŸ“±</span>
      <span>NÂ° de unidades: <strong id="unitsCount">0</strong></span>
    </span>
    
    <div class="refs-wrap">
      <button id="btnRefs" class="btn btn-icon-text" aria-expanded="false">
        <span class="icon">â„¹ï¸</span>
        <span class="text">Referencias</span>
      </button>
      <div id="refsContent" class="refs-dropdown hidden" role="menu" aria-label="Referencias de iconos">
        <div class="refs-header">Referencias de iconos</div>


<div class="refs-item">
  <img data-icon="transito" src="assets/auto_transito.svg" alt="VehÃ­culo en trÃ¡nsito" />
  <div class="refs-text">
    <div class="refs-title">VehÃ­culo en trÃ¡nsito</div>
    <div class="refs-path">En movimiento</div>
  </div>
</div>

<div class="refs-item">
  <img data-icon="detenido" src="assets/auto_detenido.svg" alt="VehÃ­culo detenido" />
  <div class="refs-text">
    <div class="refs-title">VehÃ­culo detenido</div>
    <div class="refs-path">Estacionado con motor en marcha</div>
  </div>
</div>

<div class="refs-item">
  <img data-icon="apagado" src="assets/auto_apagado.svg" alt="VehÃ­culo apagado" />
  <div class="refs-text">
    <div class="refs-title">VehÃ­culo apagado</div>
    <div class="refs-path">Estacionado con motor apagado</div>
  </div>
</div>

<div class="refs-item">
  <img data-icon="sindatos" src="assets/auto_sindatos.svg" alt="VehÃ­culo sin reportar por 5 hs" />
  <div class="refs-text">
    <div class="refs-title">VehÃ­culo sin reportar por 5 hs</div>
    <div class="refs-path">Gps sin reporte</div>
  </div>
</div>

<div class="refs-item">
  <img data-icon="panico" src="assets/auto_panico.svg" alt="VehÃ­culo en PÃ¡nico" />
  <div class="refs-text">
    <div class="refs-title">VehÃ­culo en PÃ¡nico</div>
    <div class="refs-path">Necesita asistencia inmediata</div>
  </div>
</div>





      </div>
    </div>
  </div>
</header>

  <!-- AUTH PANE -->
  <main id="authPane" class="pane">
    <div class="auth-container">
      <section class="auth-card">
        <h1>Ingreso al Sistema</h1>
        <form id="loginForm" style="margin:0">
          <input id="username" name="username" type="text" class="auth-input" placeholder="Usuario"
            autocomplete="username" autofocus autocapitalize="off" spellcheck="false" />
          <input id="password" name="password" type="password" class="auth-input" placeholder="ContraseÃ±a"
            autocomplete="current-password" />
          <button id="btnLogin" type="submit" class="auth-btn">Iniciar SesiÃ³n</button>
        </form>

      </section>
    </div>
  </main>

  <!-- MAP PANE -->
  <main id="mapPane" class="pane hidden">
    <div id="map"></div>


    <!-- REPORTS PANEL (derecha) -->
    <aside id="reportsPanel" class="right-drawer hidden">
      <header>
        <h3>Informe de KilÃ³metros</h3>
        <button id="btnCloseReports" class="btn btn-sm">Ã—</button>
      </header>
      <div class="content">
        <label>Seleccionar vehÃ­culo
          <select id="reportDeviceSelect">
            <option value="">-- Elegir --</option>
          </select>
        </label>

        <div class="grid2" style="margin-top:12px">
          <label>Desde<br /><input id="reportFrom" type="datetime-local" /></label>
          <label>Hasta<br /><input id="reportTo" type="datetime-local" /></label>
        </div>

        <button id="btnGenerateReport" class="btn btn-primary btn-sm" style="margin-top:12px">
          Generar Informe
        </button>

        <div id="reportResult" class="report-result" style="margin-top:16px; display:none;">
          <div class="section-title">Resultado</div>
          <div class="kv">
            <span class="k">ğŸš— VehÃ­culo</span>
            <span class="v" id="reportVehicleName">-</span>
          </div>
          <div class="kv">
            <span class="k">ğŸ“… PerÃ­odo</span>
            <span class="v" id="reportPeriod">-</span>
          </div>
          <div class="kv">
            <span class="k">ğŸ“ KilÃ³metros recorridos</span>
            <span class="v" id="reportKm" style="font-size:1.5em; font-weight:bold; color:#2563eb;">-</span>
          </div>
          <div class="kv">
            <span class="k">ğŸ“ Puntos procesados</span>
            <span class="v" id="reportPoints">-</span>
          </div>
          <button id="btnDownloadReport" class="btn btn-primary btn-sm" style="margin-top:12px; width:100%">
            ğŸ“„ Descargar Informe PDF
          </button>
        </div>

        <div id="reportMsg" class="muted mt-s"></div>
      </div>
    </aside>

    <!-- SEARCH PANEL (derecha) -->
    <aside id="searchPanel" class="right-drawer hidden">
      <header>
        <h3>Buscar dispositivo</h3>
        <button id="btnCloseSearch" class="btn btn-sm">Ã—</button>
      </header>
      <div class="content">
        <input id="searchId" type="text" placeholder="ID exacto..." />
        <button id="btnDoSearch" class="btn btn-primary btn-sm">Buscar</button>
        <div id="searchMsg" class="muted mt-s"></div>
      </div>
    </aside>

    <!-- FLEET PANEL (derecha) -->
    <aside id="fleetPanel" class="right-drawer hidden">
      <header>
        <h3>Mi flota</h3>
        <button id="btnCloseFleet" class="btn btn-sm">Ã—</button>
      </header>
      <div class="content">
        <ul id="fleetList"></ul>
      </div>
    </aside>

    <!-- DETAILS PANEL (derecha) -->
    <aside id="detailsPanel" class="details-panel hidden">
      <header class="details-header">
        <div>
          <div class="muted">Dispositivo</div>
          <div id="dpDevice" class="big"></div>
        </div>
        <button id="btnMinimizeDetails" class="btn btn-sm" title="Minimizar">â–¾</button>
        <button id="btnCloseDetails" class="btn btn-sm">Ã—</button>
      </header>
      <div class="details-body">

        <div class="kv"><span class="k"><span class="ico">ğŸš˜</span>Patente</span><span class="v" id="dpPlate">-</span>
        </div>
        <div class="kv"><span class="k"><span class="ico">ğŸ·ï¸</span>Marca</span><span class="v" id="dpBrand">-</span>
        </div>
        <div class="kv"><span class="k"><span class="ico">ğŸ“¦</span>Modelo</span><span class="v" id="dpModel">-</span>
        </div>
        <div class="kv"><span class="k"><span class="ico">ğŸ¨</span>Color</span><span class="v" id="dpColor">-</span>
        </div>
        <div class="section-title">Ãšltimos valores registrados</div>
        <div class="kv"><span class="k"><span class="ico">ğŸ“…</span>Fecha</span><span class="v" id="dpDate">-</span>
        </div>
        <div class="kv"><span class="k"><span class="ico">â°</span>Hora</span><span class="v" id="dpTime">-</span></div>
        <div class="kv"><span class="k"><span class="ico">ğŸ¯</span>Evento</span><span class="v" id="dpEvent">-</span>
        </div>
        <div class="kv"><span class="k"><span class="ico">ğŸš—</span>Velocidad</span><span class="v" id="dpSpeed">-</span>
        </div>
        <div class="kv"><span class="k"><span class="ico">ğŸ“¶</span>SeÃ±al</span><span class="v" id="dpSignal">-</span>
        </div>
        <div class="kv"><span class="k"><span class="ico">ğŸ”‹</span>BaterÃ­a</span><span class="v" id="dpBattery">-</span>
        </div>
        <div class="kv"><span class="k"><span class="ico">ğŸ“</span>Lat/Lon</span><span class="v" id="dpLatLon">-</span>
        </div>
        <div class="kv"><span class="k"><span class="ico">ğŸ </span>DirecciÃ³n</span><span class="v"
            id="dpAddress">-</span></div>

      </div>


      <div class="details-actions">
        <div class="group">
          <div class="group-title">Ver hoy</div>
          <div class="chips">
            <button class="chip" data-min="30">30 min</button>
            <button class="chip" data-min="45">45 min</button>
            <button class="chip" data-min="60">1 h</button>
            <button class="chip" data-min="120">2 hs</button>
            <button class="chip" data-min="360">6 hs</button>
            <button class="chip" data-min="720">12 hs</button>
          </div>
        </div>

        <div class="group">
          <div class="group-title">Ver dÃ­as anteriores</div>
          <div class="grid2">
            <label>Desde<br /><input id="dtFrom" type="datetime-local" /></label>
            <label>Hasta<br /><input id="dtTo" type="datetime-local" /></label>
          </div>
          <button id="btnApplyRange" class="btn btn-primary btn-sm">Buscar</button>
          <button id="btnDownload" class="btn btn-secondary btn-sm" disabled>Descargar ruta (CSV)</button>
        </div>
      </div>
    </aside>


    <!-- EDIT PANEL (derecha) -->
    <aside id="editPanel" class="right-drawer hidden">
      <header>
        <h3>Editar vehÃ­culo</h3>
        <button id="btnCloseEdit" class="btn btn-sm">Ã—</button>
      </header>
      <div class="content">
        <label>Dispositivo
          <select id="editDeviceSelect"></select>
        </label>

        <div class="grid2" style="margin-top:8px">
          <label>Nombre<br /><input id="editName" type="text" placeholder="CamiÃ³n 1" /></label>
          <label>Patente<br /><input id="editPlate" type="text" placeholder="AB123CD" /></label>
        </div>

        <div class="grid2" style="margin-top:8px">
          <label>Marca<br /><input id="editBrand" type="text" placeholder="Mercedes-Benz" /></label>
          <label>Modelo<br /><input id="editModel" type="text" placeholder="Actros 2540" /></label>
        </div>

        <div class="grid2" style="margin-top:8px">
          <label>Color<br /><input id="editColor" type="text" placeholder="Blanco" /></label>
          <label>Color HEX<br /><input id="editColorHex" type="color" /></label>
        </div>

        <div style="margin-top:12px">
          <button id="btnSaveMeta" class="btn btn-primary btn-sm">Guardar</button>
          <button id="btnCancelMeta" class="btn btn-secondary btn-sm">Cancelar</button>
        </div>
        <div id="editMsg" class="muted mt-s"></div>
      </div>
    </aside>

<!-- BASES PANEL (derecha) -->
<aside id="basesPanel" class="right-drawer hidden">
  <header>
    <h3>Bases de la empresa</h3>
    <button id="btnCloseBases" class="btn btn-sm">Ã—</button>
  </header>

  <div class="content">
    <div class="muted" style="margin-bottom:8px">
      PodÃ©s definir hasta <b>4 bases</b>. Cada base es un cuadrado/rectÃ¡ngulo definido por <b>4 puntos</b> (lat/lon).
    </div>

    <!-- Lista de bases existentes -->
    <div id="basesList" class="list" style="margin-bottom:12px"></div>

    <div class="section-title">Nueva base</div>
    <label>Nombre<br /><input id="baseName" type="text" placeholder="Base Central" /></label>

    <div class="grid2" style="margin-top:8px">
      <label>P1 Lat<br /><input id="p1lat" type="number" step="0.000001" placeholder="-26.80" /></label>
      <label>P1 Lon<br /><input id="p1lon" type="number" step="0.000001" placeholder="-65.25" /></label>
    </div>

    <div class="grid2" style="margin-top:8px">
      <label>P2 Lat<br /><input id="p2lat" type="number" step="0.000001" placeholder="-26.80" /></label>
      <label>P2 Lon<br /><input id="p2lon" type="number" step="0.000001" placeholder="-65.20" /></label>
    </div>

    <div class="grid2" style="margin-top:8px">
      <label>P3 Lat<br /><input id="p3lat" type="number" step="0.000001" placeholder="-26.85" /></label>
      <label>P3 Lon<br /><input id="p3lon" type="number" step="0.000001" placeholder="-65.20" /></label>
    </div>

    <div class="grid2" style="margin-top:8px">
      <label>P4 Lat<br /><input id="p4lat" type="number" step="0.000001" placeholder="-26.85" /></label>
      <label>P4 Lon<br /><input id="p4lon" type="number" step="0.000001" placeholder="-65.25" /></label>
    </div>

    <div style="margin-top:12px">
      <button id="btnAddBase" class="btn btn-primary btn-sm">Agregar base</button>
      <button id="btnCancelBase" class="btn btn-secondary btn-sm">Cancelar</button>
    </div>
    <div id="basesMsg" class="muted mt-s"></div>
  </div>
</aside>


  </main>

  <!-- FOOTER solo para login -->
  <footer id="loginFooter" class="login-footer">
    Diagnosis S.A. - Contacto: <a href="mailto:argentinadiagnosis@gmail.com">argentinadiagnosis@gmail.com</a>
  </footer>

  <!-- TOAST -->
  <div id="toast" class="toast hidden"></div>

  <!-- LIB & APP -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <!-- Antes de tus scripts existentes -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script type="module" src="./utils.js"></script>
  <script type="module" src="./api.js"></script>
  <script type="module" src="./app.js"></script>
  <script type="module" src="./editor.js"></script>
  <script type="module" src="./load-csv.js"></script>
  <script type="module" src="./bases.js"></script>
  
<script type="module">
  function normalizeType(t) {
    const s = String(t || '').toLowerCase();
    if (s.startsWith('mot')) return 'moto';
    if (s.startsWith('traf')) return 'trafic';
    if (s.startsWith('cam')) return 'camion';
    return 'auto';
  }

  function setRefIcons(type) {
    const T = normalizeType(type);
    const map = {
      transito: `assets/${T}_transito.svg`,
      detenido: `assets/${T}_detenido.svg`,
      apagado:  `assets/${T}_apagado.svg`,
      sindatos: `assets/${T}_sindatos.svg`,
      panico:   `assets/${T}_panico.svg`,
    };
    for (const [key, src] of Object.entries(map)) {
      const img = document.querySelector(`img[data-icon="${key}"]`);
      if (img) img.src = src;
    }
  }

  // Al iniciar sesiÃ³n: usa el tipo global del usuario (user.data.tipo)
  window.addEventListener('app:logged-in', () => {
    const type = window.App?.state?.user?.data?.tipo || 'auto';
    setRefIcons(type);
  });

  // Opcional: cuando elegÃ­s un dispositivo, cambia segÃºn el tipo del device
  window.addEventListener('app:device-selected', (ev) => {
    const id = ev?.detail?.id;
    const meta = window.App?.getDeviceMeta?.(id) || {};
    const type = meta.type || meta.tipo || window.App?.state?.user?.data?.tipo || 'auto';
    setRefIcons(type);
  });
</script>


  <!-- LEFT STATUS SIDEBAR (FIJA / OCULTA EN LOGIN) -->
  <aside id="statusPanel" class="left-sidebar hidden">
    <button id="btnStatusToggle" class="collapse-handle" title="Minimizar/Expandir">â®</button>

    <div class="sp-header">
      <div class="sp-title">Usuario</div>
      <div class="sp-user" id="spUser">-</div>
    </div>

    <div class="sp-body">
      <div class="sp-section-title">Mi flota</div>
      <div class="sp-row" id="spTotalRow">
        <span class="sp-icon">ğŸš˜</span>
        <span class="sp-label">Cantidad total</span>
        <span class="sp-value" id="spTotal">0</span>
      </div>

      <div class="sp-row clickable" id="spTransitRow" title="Mostrar vehÃ­culos en trÃ¡nsito">
        <span class="sp-icon">ğŸŸ¢</span>
        <span class="sp-label">En trÃ¡nsito</span>
        <span class="sp-value" id="spTransit">0</span>
      </div>

      <div class="sp-row clickable" id="spDetenidoRow" title="Mostrar vehÃ­culos detenidos/apagados">
        <span class="sp-icon">ğŸ”´</span>
        <span class="sp-label">Detenidos/Apagados</span>
        <span class="sp-value" id="spDetenido">0</span>
      </div>

      <div class="sp-row clickable" id="spSinRepRow" title="Mostrar vehÃ­culos sin reportar (â‰¥5h)">
        <span class="sp-icon">âšª</span>
        <span class="sp-label">Sin reportar (â‰¥5h)</span>
        <span class="sp-value" id="spSinRep">0</span>
      </div>
    </div>
  </aside>
</body>

</html>